{% extends 'profile/profile.html' %}
{% load widget_tweaks %}
{% load static %}



{% block extra_extra_head %}
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const calendarEl = document.getElementById('calendar');
            const calendar = new FullCalendar.Calendar(calendarEl, {
                {#themeSystem: 'bootstrap',#}
                initialView: 'timeGridWeek',
                //headerToolbar: {
                //    center: 'dayGridMonth,timeGridWeek,listWeek'
                //},
                headerToolbar: {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'dayGridMonth,timeGridWeek,timeGridDay'
                },
                views: {
                    dayGridMonth: { // name of view
                        titleFormat: {year: 'numeric', month: '2-digit', day: '2-digit'}
                    },
                    timeGridWeek: { // name of view
                        slotLabelFormat: {
                            hour: 'numeric',
                            minute: '2-digit',
                        },
                        slotMinTime: '08:00:00',
                        slotMaxTime: '25:00:00',
                        slotLabelInterval: '01:00',
                        scrollTime: '12:00',
                    },
                },
                expandRows: true,
                nowIndicator: true,
                dayMaxEvents: true,
                selectable: true,
                eventStartEditable: true,
                eventOverlap: false,
                dateClick: function (info) {  //создание нового урока
                    $("#dialog-lesson").dialog("open");
                    $("#id_time_start").val(info.dateStr).hide(); //для компьютера, нужно скрыть
                    $("label[for=id_time_start]").hide(); //лэйбел (текст рядом)
                    $("#id_time_start_prc").val(info.date.toLocaleString().replace(',', '')); // текст для людей todo удалить секунды
                    $('#id_subject').trigger('focus');
                    $('.delete-btn').hide();
                },
                eventClick: function (info) {   //редактирование урока
                    $("#dialog-lesson").dialog("open");
                    {#console.log(info);  //вывод в консоль#}
                    $("#id_time_start").val(info.event.startStr).hide(); //для компьютера, нужно скрыть
                    $("label[for=id_time_start]").hide(); //лэйбел (текст рядом)
                    $("#id_time_start_prc").val(info.event.start.toLocaleString().replace(',', ''));  //todo удалить секунды
                    $("#id_duration").val((info.event._instance.range.end - info.event._instance.range.start) / 60000);
                    $("#id_subject").val(info.event.title).trigger('focus');
                    $('.delete-btn').show();
                },
                eventDrop: function (info) {   //после отпускания урока (когда тащишь и бросаешь)
                    $("#dialog-lesson").dialog("open");
                    $("#id_time_start").val(info.event.startStr).hide(); //для компьютера, нужно скрыть
                    $("label[for=id_time_start]").hide(); //лэйбел (текст рядом)
                    $("#id_time_start_prc").val(info.event.start.toLocaleString().replace(',', ''));  //todo удалить секунды
                    $("#id_duration").val((info.event._instance.range.end - info.event._instance.range.start) / 60000);
                    $("#id_subject").val(info.event.title).trigger('focus');
                    $('.delete-btn').show();
                },
                {#timeZone: 'local',#}
                allDaySlot: false,
                events: [
                    {% for lesson in lessons %}
                        {
                            id: {{ lesson.id }},
                            title: '{{ lesson.subject }}',
                            start: '{{ lesson.time_start|date:"c" }}',
                            end: '{{ lesson.time_end|date:"c" }}',
                            {% if lesson.duration == '60' %}
                                backgroundColor: 'black',
                                textColor: 'pink'
                            {% elif lesson.duration == '45' %}
                                backgroundColor: 'pink',
                                textColor: 'black'
                            {% endif %}
                        },
                    {% endfor %}
                ]
            });
            calendar.setOption('locale', 'ru');
            calendar.render();

            $("#dialog-lesson").dialog({
                autoOpen: false,
                height: 410,
                width: 350,
                resizable: false,
                modal: true,
                closeOnEscape: true,
                open: function (event, ui) {
                    $('.ui-widget-overlay').bind('click', function () {
                        $('#dialog-lesson').dialog('close');
                    });
                },
                show: {
                    effect: 'fade',
                    duration: 200
                },
                hide: {
                    effect: 'fade',
                    duration: 200
                },
                close: function () {
                    window.location.reload();
                },
                title: 'Урок',
                closeText: "hide",
                classes: {
                    "ui-dialog": "modal-content",
                    "ui-dialog-titlebar": "modal-header",
                    "ui-dialog-title": "modal-title",
                    "ui-dialog-titlebar-close": "close",
                    "ui-dialog-content": "modal-body",
                    "ui-dialog-buttonpane": "modal-footer"
                },
            });

        });
    </script>

    <style>
        #calendar {
            background-color: #bdaeff;
            color: #000e;
            padding: 5px;
        }

        .fc-event-main-frame {
            cursor: pointer;
        }

        #dialog-lesson {
            background-color: white;
        }

        #calendar > div.fc-view-harness.fc-view-harness-active {
            height: 876px !important;
        }

        .ui-widget-overlay {
            background-color: black;
            opacity: .3;
        }

        .ui-icon, .ui-widget-content .ui-icon {
            background-image: url("{% static 'img/jqueryui/ui-icons_444444_256x240.png' %}")
        }

        .ui-widget-header .ui-icon {
            background-image: url("{% static 'img/jqueryui/ui-icons_444444_256x240.png' %}")
        }

        .ui-state-hover .ui-icon, .ui-state-focus .ui-icon, .ui-button:hover .ui-icon, .ui-button:focus .ui-icon {
            background-image: url("{% static 'img/jqueryui/ui-icons_555555_256x240.png' %}")
        }

        .ui-state-active .ui-icon, .ui-button:active .ui-icon {
            background-image: url("{% static 'img/jqueryui/ui-icons_ffffff_256x240.png' %}")
        }

        .ui-state-highlight .ui-icon, .ui-button .ui-state-highlight.ui-icon {
            background-image: url("{% static 'img/jqueryui/ui-icons_777620_256x240.png' %}")
        }

        .ui-state-error .ui-icon, .ui-state-error-text .ui-icon {
            background-image: url("{% static 'img/jqueryui/ui-icons_cc0000_256x240.png' %}")
        }

        .ui-button .ui-icon {
            background-image: url("{% static 'img/jqueryui/ui-icons_777777_256x240.png' %}")
        }

    </style>
{% endblock extra_extra_head %}
{% block right-content %}
    <div id="dialog-lesson" style="height: 100%">
        <div id="dialog-form">
            <form id="form" method="post" action="{% url 'crud_lesson' %}">
                {% csrf_token %}
                <div class="to-lesson">
                    <a href="{% url 'lesson' %}" class="lesson-btn btn btn-block">Перейти к уроку</a>
                </div>
                <div class="{% if form.non_field_errors %}invalid{% endif %} mb-2">
                    {% for error in form.non_field_errors %}
                        {{ error }}
                    {% endfor %}
                </div>
                {% for field in form %}
                    <div class="form-group">
                        <label for="{{ field.id_for_label }}">{{ field.label }}</label>
                        {% render_field field class="form-control" placeholder=field.label %}
                        <div class="{% if field.errors %} invalid{% endif %}">
                            {% for error in field.errors %}
                                <p class="help-block">{{ error }}</p>
                            {% endfor %}
                        </div>
                    </div>
                {% endfor %}
                <div id="dialog_footer" class="d-flex justify-content-between">
                    <button type="submit" class="submit-btn btn" autofocus="autofocus">Сохранить</button>
                    <button type="submit" name="delete" class="delete-btn btn">Удалить</button>
                </div>
            </form>
        </div>
    </div>

    <div id='calendar'></div>
{% endblock right-content %}

